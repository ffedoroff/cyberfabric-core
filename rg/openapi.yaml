openapi: 3.1.0
info:
  title: Resource Group API
  version: 1.0.0
  description: |
    Resource Group API based on rg/api.md.
    Supports cursor pagination and OData-style query options ($filter, $orderby, $select).
    
    OData:
    - Protocol: https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html
    - $filter: https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html#sec_SystemQueryOptionfilter
    - $select: https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html#sec_SystemQueryOptionselect
    - $orderby: https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html#sec_SystemQueryOptionorderby

    Example hierarchy:
    ```text
    tenant T1 (11111111-1111-1111-1111-111111111111)
    ├── department D2 (22222222-2222-2222-2222-222222222222)
    │   ├── branch B3 (33333333-3333-3333-3333-333333333333)
    │   │   └── resource R4
    │   └── resource R5
    ├── resource R4
    ├── resource R6
    └── tenant T7 (77777777-7777-7777-7777-777777777777)
        └── resource R8
    tenant T9 (99999999-9999-9999-9999-999999999999)
    └── resource R0
    ```
servers:
  - url: https://api.example.com
security:
  - bearerAuth: []
tags:
  - name: types
    description: Resource group types
  - name: groups
    description: Resource groups
  - name: hierarchy
    description: Ancestors and descendants queries
  - name: references
    description: Resource references bound to groups
paths:
  /api/resource-group/v1/types:
    get:
      operationId: listTypes
      tags: [types]
      summary: List resource group types
      parameters:
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationCursor'
        - $ref: '#/components/parameters/ODataFilter'
        - $ref: '#/components/parameters/ODataOrderBy'
        - $ref: '#/components/parameters/ODataSelect'
      responses:
        '200':
          description: Paginated list of types
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TypePage'
    post:
      operationId: createType
      tags: [types]
      summary: Create a resource group type
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTypeRequest'
      responses:
        '201':
          description: Type created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Type'

  /api/resource-group/v1/types/{code}:
    parameters:
      - $ref: '#/components/parameters/TypeCode'
    get:
      operationId: getType
      tags: [types]
      summary: Get a type by code
      parameters:
        - $ref: '#/components/parameters/ODataSelect'
      responses:
        '200':
          description: Type found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Type'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      operationId: updateType
      tags: [types]
      summary: Update a type by code
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTypeRequest'
      responses:
        '200':
          description: Type updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Type'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      operationId: deleteType
      tags: [types]
      summary: Delete a type by code
      responses:
        '204':
          description: Type deleted

  /api/resource-group/v1/groups:
    get:
      operationId: listGroups
      tags: [groups]
      summary: List groups with filters and pagination
      parameters:
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationCursor'
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/IdIn'
        - $ref: '#/components/parameters/ODataFilter'
        - $ref: '#/components/parameters/ODataOrderBy'
        - $ref: '#/components/parameters/ODataSelect'
      responses:
        '200':
          description: Paginated list of groups
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupPage'
    post:
      operationId: createGroup
      tags: [groups]
      summary: Create a group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGroupRequest'
      responses:
        '201':
          description: Group created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Group'

  /api/resource-group/v1/groups/{id}:
    parameters:
      - $ref: '#/components/parameters/GroupId'
    get:
      operationId: getGroup
      tags: [groups]
      summary: Get a group by id
      parameters:
        - $ref: '#/components/parameters/ODataSelect'
      responses:
        '200':
          description: Group found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Group'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      operationId: updateGroup
      tags: [groups]
      summary: Update a group by id
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateGroupRequest'
      responses:
        '200':
          description: Group updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Group'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      operationId: deleteGroup
      tags: [groups]
      summary: Delete a group by id
      parameters:
        - $ref: '#/components/parameters/DeleteForce'
      responses:
        '204':
          description: Group deleted

  /api/resource-group/v1/groups/{id}/ancestors:
    parameters:
      - $ref: '#/components/parameters/GroupId'
    get:
      operationId: listAncestors
      tags: [hierarchy]
      summary: List ancestors of a group
      parameters:
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationCursor'
        - $ref: '#/components/parameters/ODataOrderBy'
        - $ref: '#/components/parameters/ODataSelect'
      responses:
        '200':
          description: Paginated list of ancestors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HierarchyPage'

  /api/resource-group/v1/groups/{id}/descendants:
    parameters:
      - $ref: '#/components/parameters/GroupId'
    get:
      operationId: listDescendants
      tags: [hierarchy]
      summary: List descendants of a group
      parameters:
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationCursor'
        - $ref: '#/components/parameters/ODataOrderBy'
        - $ref: '#/components/parameters/ODataSelect'
      responses:
        '200':
          description: Paginated list of descendants
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HierarchyPage'

  /api/resource-group/v1/groups/ancestors:
    get:
      operationId: listAncestorsBatch
      tags: [hierarchy]
      summary: Batch read ancestors via filters
      description: Use $filter with source_group_id in (...) for batch read.
      parameters:
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationCursor'
        - $ref: '#/components/parameters/ODataFilter'
        - $ref: '#/components/parameters/ODataOrderBy'
        - $ref: '#/components/parameters/ODataSelect'
      responses:
        '200':
          description: Paginated batch ancestors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchHierarchyPage'

  /api/resource-group/v1/groups/descendants:
    get:
      operationId: listDescendantsBatch
      tags: [hierarchy]
      summary: Batch read descendants via filters
      description: Use $filter with source_group_id in (...) for batch read.
      parameters:
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationCursor'
        - $ref: '#/components/parameters/ODataFilter'
        - $ref: '#/components/parameters/ODataOrderBy'
        - $ref: '#/components/parameters/ODataSelect'
      responses:
        '200':
          description: Paginated batch descendants
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchHierarchyPage'

  /api/resource-group/v1/groups/{id}/references:
    parameters:
      - $ref: '#/components/parameters/GroupId'
    get:
      operationId: listGroupReferences
      tags: [references]
      summary: List references bound to a group
      parameters:
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationCursor'
        - $ref: '#/components/parameters/ODataFilter'
        - $ref: '#/components/parameters/ODataOrderBy'
        - $ref: '#/components/parameters/ODataSelect'
      responses:
        '200':
          description: Paginated references
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReferencePage'
    post:
      operationId: addGroupReference
      tags: [references]
      summary: Attach reference to a group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateReferenceRequest'
      responses:
        '201':
          description: Reference attached
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reference'
    delete:
      operationId: deleteGroupReference
      tags: [references]
      summary: Detach reference from a group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteReferenceRequest'
      responses:
        '204':
          description: Reference detached

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    GroupId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    TypeCode:
      name: code
      in: path
      required: true
      schema:
        type: string
    TenantId:
      name: tenant_id
      in: query
      required: false
      schema:
        type: string
        format: uuid
    IdIn:
      name: id.in
      in: query
      required: false
      description: Comma-separated list of group IDs for collection filtering.
      schema:
        type: string
    DeleteForce:
      name: force
      in: query
      required: false
      schema:
        type: boolean
        default: false
    PaginationLimit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
    PaginationCursor:
      name: cursor
      in: query
      required: false
      schema:
        type: string
    ODataSelect:
      name: $select
      in: query
      required: false
      description: OData v4.01 field projection.
      schema:
        type: string
    ODataOrderBy:
      name: $orderby
      in: query
      required: false
      description: OData v4.01 ordering expression.
      schema:
        type: string
    ODataFilter:
      name: $filter
      in: query
      required: false
      description: |
        OData v4.01 filter expression.
      schema:
        type: string

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Problem'

  schemas:
    Problem:
      type: object
      properties:
        type: { type: string }
        title: { type: string }
        status: { type: integer }
        detail: { type: string }
        trace_id: { type: string }

    PageInfo:
      type: object
      required: [limit]
      properties:
        limit:
          type: integer
        next_cursor:
          type: [string, 'null']
        prev_cursor:
          type: [string, 'null']

    Type:
      type: object
      required: [code, ancestors]
      properties:
        code:
          type: string
        ancestors:
          type: array
          items:
            type: string

    TypePage:
      type: object
      required: [items, page_info]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Type'
        page_info:
          $ref: '#/components/schemas/PageInfo'

    CreateTypeRequest:
      type: object
      required: [code, ancestors]
      properties:
        code:
          type: string
        ancestors:
          type: array
          items:
            type: string

    UpdateTypeRequest:
      type: object
      properties:
        ancestors:
          type: array
          items:
            type: string

    Group:
      type: object
      required: [id, group_type, name, tenant_id]
      properties:
        id:
          type: string
          format: uuid
        parent_id:
          type: [string, 'null']
          format: uuid
        group_type:
          type: string
        name:
          type: string
        tenant_id:
          type: string
          format: uuid
        external_id:
          type: [string, 'null']
        created:
          type: [string, 'null']
          format: date-time
        modified:
          type: [string, 'null']
          format: date-time

    GroupPage:
      type: object
      required: [items, page_info]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Group'
        page_info:
          $ref: '#/components/schemas/PageInfo'

    CreateGroupRequest:
      type: object
      required: [group_type, name, tenant_id]
      properties:
        group_type:
          type: string
        name:
          type: string
        parent_id:
          type: [string, 'null']
          format: uuid
        tenant_id:
          type: string
          format: uuid
        external_id:
          type: [string, 'null']

    UpdateGroupRequest:
      type: object
      properties:
        name:
          type: string
        parent_id:
          type: [string, 'null']
          format: uuid
        external_id:
          type: [string, 'null']

    HierarchyItem:
      type: object
      required: [group, depth]
      properties:
        group:
          $ref: '#/components/schemas/Group'
        depth:
          type: integer

    HierarchyPage:
      type: object
      required: [items, page_info]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/HierarchyItem'
        page_info:
          $ref: '#/components/schemas/PageInfo'

    BatchHierarchyItem:
      type: object
      required: [source_group_id, group, depth]
      properties:
        source_group_id:
          type: string
          format: uuid
        group:
          $ref: '#/components/schemas/Group'
        depth:
          type: integer

    BatchHierarchyPage:
      type: object
      required: [items, page_info]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/BatchHierarchyItem'
        page_info:
          $ref: '#/components/schemas/PageInfo'

    Reference:
      type: object
      required: [group_id, resource_type, resource_id, tenant_id]
      properties:
        group_id:
          type: string
          format: uuid
        resource_type:
          type: string
        resource_id:
          type: string
        tenant_id:
          type: string
          format: uuid

    ReferencePage:
      type: object
      required: [items, page_info]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Reference'
        page_info:
          $ref: '#/components/schemas/PageInfo'

    CreateReferenceRequest:
      type: object
      required: [resource_type, resource_id, tenant_id]
      properties:
        resource_type:
          type: string
        resource_id:
          type: string
        tenant_id:
          type: string
          format: uuid

    DeleteReferenceRequest:
      type: object
      required: [resource_type, resource_id, tenant_id]
      properties:
        resource_type:
          type: string
        resource_id:
          type: string
        tenant_id:
          type: string
          format: uuid
