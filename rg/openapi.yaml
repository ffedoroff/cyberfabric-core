openapi: 3.1.0
info:
  title: Resource Group API
  version: 1.0.0
  description: |
    Resource Group API based on rg/api.md.
    Supports cursor pagination and OData-style query options ($filter, $orderby, $select).

    OData:
    - Protocol: https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html
    - $filter: https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html#sec_SystemQueryOptionfilter
    - $select: https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html#sec_SystemQueryOptionselect
    - $orderby: https://docs.oasis-open.org/odata/odata/v4.01/odata-v4.01-part1-protocol.html#sec_SystemQueryOptionorderby

    Example types:
    ```text
      tenant (ancestors: ["", tenant])
      └── department (ancestors: [tenant])
          └── branch (ancestors: [department])
    ```

    Example hierarchy:
    ```text
      tenant T1 (11111111-1111-1111-1111-111111111111)
      ├── department D2 (22222222-2222-2222-2222-222222222222)
      │   ├── branch B3 (33333333-3333-3333-3333-333333333333)
      │   │   └── resource R4
      │   └── resource R5
      ├── resource R4
      ├── resource R6
      └── tenant T7 (77777777-7777-7777-7777-777777777777)
          └── resource R8
      tenant T9 (99999999-9999-9999-9999-999999999999)
      └── resource R0
    ```
servers:
  - url: https://api.example.com
security:
  - bearerAuth: []
tags:
  - name: types
    description: Resource group types
  - name: groups
    description: Resource groups
  - name: memberships
    description: Resource memberships bound to groups

paths:
  /api/resource-group/v1/types:
    get:
      operationId: listTypes
      tags: [types]
      summary: List resource group types
      description: |
        Returns paginated resource group types using cursor-based pagination with OData query support. Use `$orderby`, `$filter`, and `$select` for advanced queries.

        OData support:
        - `$orderby`:
          - `code` (asc, desc)
        - `$filter`:
          - `code` (eq, ne, in, contains, startswith, endswith)
        - `$select`:
          - `ancestors`
          - `code`
      x-odata-orderby:
        supported_fields: [code]
        supported_directions: [asc, desc]
      x-odata-filter:
        supported_fields:
          code: [eq, ne, in, contains, startswith, endswith]
      x-odata-select:
        supported_fields: [code, ancestors]
      parameters:
        - $ref: '#/components/parameters/ODataFilter'
        - $ref: '#/components/parameters/ODataOrderBy'
        - $ref: '#/components/parameters/ODataSelect'
        - $ref: '#/components/parameters/PaginationLimit'
      responses:
        '200':
          description: Paginated list of types
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TypePage'
              example:
                items:
                  - ancestors: [tenant]
                    code: department
                  - ancestors: ['', tenant]
                    code: tenant
                  - ancestors: [department]
                    code: branch
                page_info:
                  limit: 50
                  next_cursor: null
                  prev_cursor: null
    post:
      operationId: createType
      tags: [types]
      summary: Create a resource group type
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTypeRequest'
            example:
              ancestors: [tenant]
              code: department
      responses:
        '201':
          description: Type created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Type'
              example:
                ancestors: [tenant]
                code: department

  /api/resource-group/v1/types/{code}:
    parameters:
      - $ref: '#/components/parameters/TypeCode'
    get:
      operationId: getType
      tags: [types]
      summary: Get a type by code
      description: |
        Returns a single resource group type by `code`. Use `$select` to project fields in the response.

        OData support:
        - `$select`:
          - `ancestors`
          - `code`
      x-odata-select:
        supported_fields: [code, ancestors]
      parameters:
        - $ref: '#/components/parameters/ODataSelect'
      responses:
        '200':
          description: Type found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Type'
              example:
                ancestors: [tenant]
                code: department
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      operationId: deleteType
      tags: [types]
      summary: Delete a type by code
      responses:
        '204':
          description: Type deleted

  /api/resource-group/v1/groups:
    get:
      operationId: listGroups
      tags: [groups]
      summary: List groups with filters and pagination
      description: |
        Returns paginated resource groups using cursor-based pagination with OData query support. Use `$orderby`, `$filter`, and `$select` for advanced queries.

        OData support:
        - `$orderby`:
          - `created` (asc, desc)
          - `external_id` (asc, desc)
          - `group_type` (asc, desc)
          - `id` (asc, desc)
          - `modified` (asc, desc)
          - `name` (asc, desc)
          - `parent_id` (asc, desc)
          - `tenant_id` (asc, desc)
        - `$filter`:
          - `depth` (eq, ne, gt, ge, lt, le)
          - `external_id` (eq, ne, in, contains, startswith, endswith)
          - `group_type` (eq, ne, in)
          - `id` (eq, ne, in)
          - `name` (eq, ne, in, contains, startswith, endswith)
          - `parent_id` (eq, ne, in)
          - `tenant_id` (eq, ne, in)
          - `resources/resource_id` (eq, ne, in, contains, startswith, endswith) Real OData: `any(r: r/resource_id eq '123')`
          - `resources/resource_tenant_id` (eq, ne, in)
          - `resources/resource_type` (eq, ne, in)
        - `$select`:
          - `created`
          - `depth`
          - `external_id`
          - `group_type`
          - `id`
          - `modified`
          - `name`
          - `parent_id`
          - `tenant_id`
          - `resources/created`
          - `resources/resource_id`
          - `resources/resource_tenant_id`
          - `resources/resource_type`
      x-odata-orderby:
        supported_fields: [id, parent_id, group_type, name, tenant_id, external_id, created, modified]
        supported_directions: [asc, desc]
      x-odata-filter:
        supported_fields:
          id: [eq, ne, in]
          parent_id: [eq, ne, in]
          group_type: [eq, ne, in]
          name: [eq, ne, in, contains, startswith, endswith]
          tenant_id: [eq, ne, in]
          external_id: [eq, ne, in, contains, startswith, endswith]
      x-odata-select:
        supported_fields: [id, parent_id, group_type, name, tenant_id, external_id, created, modified]
      parameters:
        - $ref: '#/components/parameters/ODataFilter'
        - $ref: '#/components/parameters/ODataOrderBy'
        - $ref: '#/components/parameters/ODataSelect'
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/TenantId'
      responses:
        '200':
          description: Paginated list of groups
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupPage'
              example:
                items:
                  - external_id: D2
                    group_type: department
                    id: 22222222-2222-2222-2222-222222222222
                    name: D2
                    parent_id: 11111111-1111-1111-1111-111111111111
                    tenant_id: 11111111-1111-1111-1111-111111111111
                    resources:
                      - created: today
                        resource_id: 11002222-2222-2222-2222-222222222222
                        resource_tenant_id: 11111111-1111-1111-1111-111111111111
                        resource_type: user
                      - created: tomorrow
                        resource_id: 678
                        resource_tenant_id: 11111111-1111-1111-1111-111111111111
                        resource_type: car
                page_info:
                  limit: 50
                  next_cursor: null
                  prev_cursor: null
    post:
      operationId: createGroup
      tags: [groups]
      summary: Create a group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGroupRequest'
            example:
              external_id: D2
              group_type: department
              name: D2
              parent_id: 11111111-1111-1111-1111-111111111111
              tenant_id: 11111111-1111-1111-1111-111111111111
      responses:
        '201':
          description: Group created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Group'
              example:
                created: '2026-02-25T12:00:00.000Z'
                external_id: D2
                group_type: department
                id: 22222222-2222-2222-2222-222222222222
                modified: null
                name: D2
                parent_id: 11111111-1111-1111-1111-111111111111
                tenant_id: 11111111-1111-1111-1111-111111111111

  /api/resource-group/v1/groups/{id}:
    parameters:
      - $ref: '#/components/parameters/GroupId'
    get:
      operationId: getGroup
      tags: [groups]
      summary: Get a group by id
      description: |
        Returns a single group by `id`. Use `$select` to project fields in the response.

        OData support:
        - `$select`:
          - `created`
          - `external_id`
          - `group_type`
          - `id`
          - `modified`
          - `name`
          - `parent_id`
          - `tenant_id`
      x-odata-select:
        supported_fields: [id, parent_id, group_type, name, tenant_id, external_id, created, modified]
      parameters:
        - $ref: '#/components/parameters/ODataSelect'
      responses:
        '200':
          description: Group found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Group'
              example:
                external_id: D2
                group_type: department
                id: 22222222-2222-2222-2222-222222222222
                name: D2
                parent_id: 11111111-1111-1111-1111-111111111111
                tenant_id: 11111111-1111-1111-1111-111111111111
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      operationId: deleteGroup
      tags: [groups]
      summary: Delete a group by id
      parameters:
        - $ref: '#/components/parameters/DeleteForce'
      responses:
        '204':
          description: Group deleted

  /api/resource-group/v1/groups/{id}/resources:
    parameters:
      - $ref: '#/components/parameters/GroupId'
    get:
      operationId: listGroupResources
      tags: [memberships]
      summary: List resources bound to a group
      description: |
        Returns paginated resources bound to a group using cursor-based pagination with OData query support. Use `$orderby`, `$filter`, and `$select` for advanced queries.

        OData support:
        - `$orderby`:
          - `created` (asc, desc)
          - `resource_id` (asc, desc)
          - `resource_type` (asc, desc)
          - `tenant_id` (asc, desc)
        - `$filter`:
          - `created` (eq, ne, gt, ge, lt, le)
          - `resource_id` (eq, ne, in, contains, startswith, endswith)
          - `resource_type` (eq, ne, in)
          - `tenant_id` (eq, ne, in)
        - `$select`:
          - `created`
          - `group_id`
          - `resource_id`
          - `resource_type`
          - `tenant_id`
      x-odata-orderby:
        supported_fields: [created, resource_id, resource_type, tenant_id]
        supported_directions: [asc, desc]
      x-odata-filter:
        supported_fields:
          created: [eq, ne, gt, ge, lt, le]
          resource_id: [eq, ne, in, contains, startswith, endswith]
          resource_type: [eq, ne, in]
          tenant_id: [eq, ne, in]
      x-odata-select:
        supported_fields: [created, group_id, resource_id, resource_type, tenant_id]
      parameters:
        - $ref: '#/components/parameters/ODataFilter'
        - $ref: '#/components/parameters/ODataOrderBy'
        - $ref: '#/components/parameters/ODataSelect'
        - $ref: '#/components/parameters/PaginationCursor'
        - $ref: '#/components/parameters/PaginationLimit'
      responses:
        '200':
          description: Paginated resources
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MembershipPage'
              example:
                items:
                  - created: '2026-02-25T12:00:00.000Z'
                    group_id: 33333333-3333-3333-3333-333333333333
                    resource_id: R4
                    resource_type: resource
                    tenant_id: 11111111-1111-1111-1111-111111111111
                page_info:
                  limit: 50
                  next_cursor: null
                  prev_cursor: null
    post:
      operationId: addGroupMembership
      tags: [memberships]
      summary: Attach membership to a group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMembershipRequest'
            example:
              resource_id: R4
              resource_type: resource
              tenant_id: 11111111-1111-1111-1111-111111111111
      responses:
        '201':
          description: Membership attached
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Membership'
              example:
                created: '2026-02-25T12:00:00.000Z'
                group_id: 33333333-3333-3333-3333-333333333333
                resource_id: R4
                resource_type: resource
                tenant_id: 11111111-1111-1111-1111-111111111111
    delete:
      operationId: deleteGroupMembership
      tags: [memberships]
      summary: Detach membership from a group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteMembershipRequest'
            example:
              resource_id: R4
              resource_type: resource
              tenant_id: 11111111-1111-1111-1111-111111111111
      responses:
        '204':
          description: Membership detached

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    GroupId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      example: 22222222-2222-2222-2222-222222222222

    TypeCode:
      name: code
      in: path
      required: true
      schema:
        type: string
      example: department

    TenantId:
      name: tenant_id
      in: query
      required: false
      schema:
        type: string
        format: uuid
      example: 11111111-1111-1111-1111-111111111111

    DeleteForce:
      name: force
      in: query
      required: false
      schema:
        type: boolean
        default: false
      example: false

    PaginationLimit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 300
        default: 50
      example: 50

    ODataSelect:
      name: $select
      in: query
      required: false
      description: OData v4.01 field projection.
      schema:
        type: string

    ODataOrderBy:
      name: $orderby
      in: query
      required: false
      description: OData v4.01 ordering expression.
      schema:
        type: string

    ODataFilter:
      name: $filter
      in: query
      required: false
      description: |
        OData v4.01 filter expression.
      schema:
        type: string

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Problem'
          example:
            detail: Requested entity does not exist
            status: 404
            title: Resource not found
            trace_id: 01HXYZRGNOTFOUND
            type: https://api.example.com/errors/not-found

  schemas:
    Problem:
      type: object
      properties:
        type: { type: string }
        title: { type: string }
        status: { type: integer }
        detail: { type: string }
        trace_id: { type: string }
      example:
        detail: Requested entity does not exist
        status: 404
        title: Resource not found
        trace_id: 01HXYZRGNOTFOUND
        type: https://api.example.com/errors/not-found

    PageInfo:
      type: object
      required: [limit]
      properties:
        limit:
          type: integer
        next_cursor:
          type: [string, 'null']
        prev_cursor:
          type: [string, 'null']
      example:
        limit: 50
        next_cursor: null
        prev_cursor: null

    Type:
      type: object
      required: [code, ancestors]
      properties:
        code:
          type: string
          example: department
        ancestors:
          type: array
          items:
            type: string
          example: [tenant]

    TypePage:
      type: object
      required: [items, page_info]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Type'
        page_info:
          $ref: '#/components/schemas/PageInfo'
      example:
        items:
          - ancestors: ['', tenant]
            code: tenant
          - ancestors: [tenant]
            code: department
          - ancestors: [department]
            code: branch
        page_info:
          limit: 50
          next_cursor: null
          prev_cursor: null

    CreateTypeRequest:
      type: object
      required: [code, ancestors]
      properties:
        code:
          type: string
          example: department
        ancestors:
          type: array
          items:
            type: string
          example: [tenant]

    Group:
      type: object
      required: [id, group_type, name, tenant_id]
      properties:
        id:
          type: string
          format: uuid
          example: 22222222-2222-2222-2222-222222222222
        parent_id:
          type: [string, 'null']
          format: uuid
          example: 11111111-1111-1111-1111-111111111111
        group_type:
          type: string
          example: department
        name:
          type: string
          example: D2
        tenant_id:
          type: string
          format: uuid
          example: 11111111-1111-1111-1111-111111111111
        external_id:
          type: [string, 'null']
          example: D2
        created:
          type: [string, 'null']
          format: date-time
          example: '2026-02-25T12:00:00.000Z'
        modified:
          type: [string, 'null']
          format: date-time
          example: null

    GroupPage:
      type: object
      required: [items, page_info]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Group'
        page_info:
          $ref: '#/components/schemas/PageInfo'
      example:
        items:
          - external_id: D2
            group_type: department
            id: 22222222-2222-2222-2222-222222222222
            name: D2
            parent_id: 11111111-1111-1111-1111-111111111111
            tenant_id: 11111111-1111-1111-1111-111111111111
        page_info:
          limit: 50
          next_cursor: null
          prev_cursor: null

    CreateGroupRequest:
      type: object
      required: [group_type, name, tenant_id]
      properties:
        group_type:
          type: string
          example: department
        name:
          type: string
          example: D2
        parent_id:
          type: [string, 'null']
          format: uuid
          example: 11111111-1111-1111-1111-111111111111
        tenant_id:
          type: string
          format: uuid
          example: 11111111-1111-1111-1111-111111111111
        external_id:
          type: [string, 'null']
          example: D2

    Membership:
      type: object
      required: [created, group_id, resource_id, resource_type, tenant_id]
      properties:
        created:
          type: string
          format: date-time
          example: '2026-02-25T12:00:00.000Z'
        group_id:
          type: string
          format: uuid
          example: 33333333-3333-3333-3333-333333333333
        resource_id:
          type: string
          example: R4
        resource_type:
          type: string
          example: resource
        tenant_id:
          type: string
          format: uuid
          example: 11111111-1111-1111-1111-111111111111

    MembershipPage:
      type: object
      required: [items, page_info]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Membership'
        page_info:
          $ref: '#/components/schemas/PageInfo'
      example:
        items:
          - created: '2026-02-25T12:00:00.000Z'
            group_id: 33333333-3333-3333-3333-333333333333
            resource_id: R4
            resource_type: resource
            tenant_id: 11111111-1111-1111-1111-111111111111
        page_info:
          limit: 50
          next_cursor: null
          prev_cursor: null

    CreateMembershipRequest:
      type: object
      required: [resource_id, resource_type, tenant_id]
      properties:
        resource_id:
          type: string
          example: R4
        resource_type:
          type: string
          example: resource
        tenant_id:
          type: string
          format: uuid
          example: 11111111-1111-1111-1111-111111111111

    DeleteMembershipRequest:
      type: object
      required: [resource_id, resource_type, tenant_id]
      properties:
        resource_id:
          type: string
          example: R4
        resource_type:
          type: string
          example: resource
        tenant_id:
          type: string
          format: uuid
          example: 11111111-1111-1111-1111-111111111111
